<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>demo</title>
    <link rel="stylesheet" href="style/base.css">
</head>
<body ng-app="mainApp">
<div class="content" ng-controller="mainCtr">
    <div class="editor-box">
        <div id="editor"></div>
    </div>
    <div class="editorTipBox"></div>
</div>


<script src="js/angular.min.js"></script>
<script src="http://lib.baomitu.com/jquery/2.2.4/jquery.js"></script>
<script src="js/grammar/grammar.parser.min.js"></script>
<script src="js/ace/ace.js"></script>
<script src="js/ace/ext-language_tools.js"></script>
<script>
    let app = angular.module('mainApp',[]);


    app.controller('mainCtr',function ($scope,editorUtil) {
        $scope.editorMode = {
            editor:null,
            init(){
                this.editor = editorUtil.init('editor');
            }
        };

        $scope.editorMode.init();
    });


    app.service('editorUtil',function () {
        return {
            editor:null,
            gp:null,
            init(selector){
                this.gp =  new GrammarParser({type:'lucene',publicPath:'./js'});

                this.editor = ace.edit(selector);
                this.editor.$blockScrolling = Infinity;
                this.editor.setOptions({wrap:'free',enableBasicAutocompletion: true, enableSnippets: true, enableLiveAutocompletion: true});
                this.editor.getSession().setMode('ace/mode/customJson');

                var langTools = ace.require("ace/ext/language_tools");
                // langTools.autocomplete

                this.editor.getSession().on('change',(evt,session) => {
                    let content = session.doc.$lines.join('\n');
                    let result = this.gp.parse(content);
                    if(result.success){
                        //校验成功
                        console.log(result.res);
                        this.editor.getSession().setAnnotations([]);
                    }else {
                        let row = evt.end.row;
                        if(evt.action !== 'insert')
                            row = evt.start.row;
                        this.showErrorInfo(result.error,row);
                    }
                });

                return editor;
            },
            showErrorInfo(e,row){
                this.editor.getSession().setAnnotations([{
                    row:row,
                    column:0,
                    text:e.name + '\n' + e.message,
                    type:'error'
                }]);
            }
        }
    });

</script>
</body>
</html>